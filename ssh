#!/bin/bash
# Simple ssh wrapper, in order to easily access:
# 1) my home servers from my laptop when I am away from HOME_GR
# 2) my work pc
# 3) my laptop

SSID_GR="guru"
SSID_CZ="steele"
SSID_SUSE="AttachmateGroup"
SSH="/usr/bin/ssh"
ADDR="home.tampakrap.gr -p"
# TODO PARSE THEM FROM ~/.sshconfig
SERVER1_NAME="eyedea"
SERVER1_PORT="2107"
SERVER2_NAME="evidence"
SERVER2_PORT="2108"
SERVER3_NAME="everlast"
SERVER3_PORT="2109"

# In the next two if blocks:
# 1) Check if the current machine is connected through ethernet or wireless
# 2) Check if it is inside HOME_GR, HOME_CZ or SUSE
if [[ -a /sbin/iwconfig ]]; then
	CURRENT_SSID=`/sbin/iwconfig wlan0 | grep ESSID | awk -F: '{ print $2 }' | tr -d '"'`
	CURRENT_SSID=${CURRENT_SSID//[[:space:]]}
	if [[ $CURRENT_SSID == "off/any" ]]; then
		# Not in wireless mode
		CURRENT_SSID=''
	else
		case $CURRENT_SSID in
			$SSID_GR) HOME_GR=1 ;;
			$SSID_CZ) HOME_CZ=1 ;;
			$SSID_SUSE) SUSE=1 ;;
		esac
	fi
fi
if [[ ! -n $CURRENT_SSID ]]; then
	CURRENT_IP=`/sbin/ifconfig eth0 | grep 'inet' | awk '{ print $2}' | cut -d. -f1-3`
	case $CURRENT_IP in
		"192.168.2") HOME_GR=1 ;;
		"192.168.11") HOME_CZ=1 ;;
		10.[12]0.*) SUSE=1 ;; 
	esac
fi

# Check if the machine is connected to SUSE VPN
if [[ ! -n $SUSE ]] && grep -q 10.[12]0 /etc/resolv.conf; then
	SUSE=1
fi

# Connect to HOME_GR servers
if [[ $1 == $SERVER1_NAME ]] || [[ $1 == $SERVER2_NAME ]] || [[ $1 == $SERVER3_NAME ]]; then
	if [[ -n $HOME_GR ]]; then
		$SSH $@
	else
		case "$1" in
			$SERVER1_NAME) $SSH $ADDR $SERVER1_PORT ;;
			$SERVER2_NAME) $SSH $ADDR $SERVER2_PORT ;;
			$SERVER3_NAME) $SSH $ADDR $SERVER3_PORT ;;
		esac
	fi
# Connect to xzibit
elif [[ $1 == "xzibit" ]]; then
	if [[ -n $SUSE ]]; then
		$SSH $@
	else
		echo "You need to connect to SUSE VPN first"
	fi
# Connect to virtuoso
# Based on common sense:
# 1) if I'm at work then virtuoso is at HOME_CZ
# 2) if I'm at HOME_GR, then virtuoso is also there
elif [[ $1 == "virtuoso" ]]; then
	if [[ -n $HOME_GR ]]; then
		$SSH 192.168.2.102
	else
		$SSH 192.168.11.102
	fi
else
	$SSH $@
fi
