#!/bin/bash
# Simple ssh wrapper, in order to easily access:
# 1) my home servers when I am away from HOME_GR
# 2) my work pc
# 3) my laptop / mobile

SSID_GR="guru"
SSID_CZ="steele"
SSID_SUSE="AttachmateGroup"
SSH="/usr/bin/ssh"
NEWARGS="$@"

_check_home_gr() {
    [[ -n $HOME_GR ]] || NEWARGS=${NEWARGS/$TARGET/$TARGET.tampakrap.gr}
}

# In the next two if blocks:
# 1) Check if the current machine is connected through ethernet or wireless
# 2) Check if it is inside HOME_GR, HOME_CZ or SUSE
if [[ -a /sbin/iwconfig ]]; then
	CURRENT_SSID=`/sbin/iwconfig wlan0 | grep ESSID | awk -F: '{ print $2 }' | tr -d '"'`
	CURRENT_SSID=${CURRENT_SSID//[[:space:]]}
	if [[ $CURRENT_SSID == "off/any" ]]; then
		# Not in wireless mode
		CURRENT_SSID=
	else
		case $CURRENT_SSID in
			$SSID_GR) HOME_GR=1 ;;
			$SSID_CZ) HOME_CZ=1 ;;
			$SSID_SUSE) SUSE=1 ;;
		esac
	fi
fi
if [[ ! -n $CURRENT_SSID ]]; then
	CURRENT_IP=`/sbin/ifconfig eth0 | grep 'inet' | awk '{ print $2}' | cut -d. -f1-3`
	case $CURRENT_IP in
		"192.168.2") HOME_GR=1 ;;
		"192.168.11") HOME_CZ=1 ;;
		10.[12]0.*) SUSE=1 ;;
	esac
fi

# Check if the machine is connected to SUSE VPN
if [[ ! -n $SUSE ]] && grep -q 10.[12]0 /etc/resolv.conf; then
	SUSE=1
fi

# Check if the list of arguments include any of my boxes
for ARG in $NEWARGS; do
    if [[ $ARG != -* ]]; then
        [[ "$ARG" =~ "@" ]] && NEWARGS="${ARG/*@/} -l ${ARG/@*/} ${NEWARGS/$ARG/}"
        [[ `grep $ARG /etc/hosts | awk '{ print $2 }'` ]] && TARGET="${ARG/*@/}" && break
    fi
done
IFS=$' '
case $TARGET in
    eyedea) _check_home_gr ;;
    evidence) _check_home_gr ;;
    everlast) _check_home_gr ;;
    canibus) _check_home_gr ;;
    madlib) _check_home_gr ;;
    xzibit)
        [[ ! -n $SUSE ]] && echo "You need to connect to SUSE VPN first" && exit 1
        ;;
    virtuoso)
        # Based on common sense:
        # 1) if I'm at work or HOME_CZ then virtuoso is at HOME_CZ
        # 2) if I'm at HOME_GR, then virtuoso is also there
        IP="102"
        if [[ -n $HOME_GR ]]; then
            NEWTARGET="192.168.2.$IP"
        elif [[ -n $HOME_CZ ]]; then
            NEWTARGET="192.168.11.$IP"
        else
            NEWTARGET=$TARGET.tampakrap.gr
        fi
        NEWARGS=${NEWARGS/$TARGET/$NEWTARGET}
        ;;
    apathy)
        # Based on common sense, apathy is always with me :P
        IP="110"
        if [[ -n $HOME_GR ]]; then
            NEWTARGET="192.168.2.$IP"
        elif [[ -n $HOME_CZ ]]; then
            NEWTARGET="192.168.11.$IP"
        #elif [[ -n $SUSE ]]; then
        #    Need to get a static IP first
        #    $SSH $NEWARGS $IP
        fi
        NEWARGS=${NEWARGS/$TARGET/$NEWTARGET}
        ;;
esac

$SSH ${NEWARGS}
