#!/bin/bash
# This script creates symlinks of the various personal scripts I keep in my tampakrap/scripts.git repository

. /etc/init.d/functions.sh

if [[ $(whoami) != "root" ]]; then
	eerror "Must be run as root, terminating"
	exit 1
fi

USER="tampakrap"

function _repository() {
	if [[ -n ${HOMEDIR} ]]; then
		REPOSITORY="/home/$USER/Source_Code/raekwon/scripts"
	else
		REPOSITORY="/var/repos/scripts"
		pushd $REPOSITORY > /dev/null 2>&1
		git pull > /dev/null
		popd > /dev/null 2>&1
	fi

    source $REPOSITORY/create_symlinks_functions
}

function _update_scripts() {
	local DESTINATIONS="/usr/local/sbin /usr/local/bin"

	einfo "Updating scripts for ${HOSTNAME}"

	# Include scripts from work repository
	[[ -n ${WORK} ]] && WORK_REPOSITORY="/home/$USER/Source_Code/suse/$USER/scripts"

	# Install the scripts
	for DESTINATION in ${DESTINATIONS}; do
		if [[ ${DESTINATION} == "/usr/local/sbin" ]]; then
			SCRIPTS=${SBIN}
		else
			SCRIPTS=${BIN}
		fi
		for FILE in ${SCRIPTS}; do
			TARGET=${FILE}
			if [[ -f ${REPOSITORY}/${TARGET} ]]; then
                SOURCE_DIR="${REPOSITORY}"
				_install_file
			elif [[ -n ${WORK} ]] && [[ -f ${WORK_REPOSITORY}/${TARGET} ]]; then
                SOURCE_DIR="${WORK_REPOSITORY}"
				_install_file
			fi
		done
		# Install additional work scripts that don't reside in WORK_REPOSITORY
		[[ -n ${WORK} ]] && ${WORK_REPOSITORY}/create_work_symlinks
	done

	einfo "Done"
}

function _update_configs() {
	einfo "Updating configs for ${HOSTNAME}"

	SOURCE_DIR="${REPOSITORY}/configs"
	for FILE in `ls ${SOURCE_DIR}`; do
		case $FILE in
			user.*)
				if [[ -n ${HOMEDIR} ]]; then
					DESTINATION="/home/$USER"
					case $FILE in
						user.ssh) TARGET=".ssh/config" ;;
                        user.gpg-agent.conf) TARGET=".gnupg/gpg-agent.conf" ;;
						*) TARGET=".${FILE##*.}" ;;
					esac
				fi
				;;
			root.*)
				DESTINATION="/root"
				TARGET=".${FILE##*.}"
				;;
			etc.*)
				DESTINATION="/etc"
				case $FILE in
					etc.vimrc.local) TARGET="vim/vimrc.local" ;;
					*) TARGET=".${FILE##*.}" ;;
				esac
				;;
		esac
		_install_file
	done

    [[ -L /etc/hosts.d ]] || ( ln -s ${REPOSITORY}/hosts.d /etc && ewarn "Installed hosts.d" )

	einfo "Done"
}

case $HOSTNAME in
	canibus)
		SBIN="cleanup create_symlinks emerge-tmpfs host-update update"
		BIN="create_repolinks git packagelist ssh wakeonlan"
		HOMEDIR=1
		;;
	virtuoso)
		SBIN="cleanup create_symlinks emerge-tmpfs host-update update"
		BIN="create_repolinks music-sync git packagelist ssh wakeonlan"
		HOMEDIR=1
		WORK=1
		;;
	madlib)
		SBIN="cleanup create_symlinks emerge-tmpfs host-update update"
		BIN="wakeonlan"
		;;
	eyedea)
		SBIN="cleanup create_symlinks emerge-tmpfs host-update update-notifier"
		BIN="wakeonlan"
		;;
	evidence)
		SBIN="cleanup create_symlinks emerge-tmpfs host-update update-notifier"
		BIN="wakeonlan"
		;;
	everlast)
		SBIN="cleanup create_symlinks emerge-tmpfs host-update update-notifier"
		BIN="wakeonlan"
		;;
	raekwon)
		SBIN="cleanup create_symlinks emerge-tmpfs host-update update-notifier"
		BIN="wakeonlan"
		;;
	xzibit)
		SBIN="cleanup create_symlinks emerge-tmpfs host-update update"
		BIN="create_repolinks get-swamp-id git packagelist ssh wakeonlan"
		HOMEDIR=1
		WORK=1
		;;
	*)
		eerror "${HOSTNAME} not found, terminating"
		exit 1
esac

_repository
_update_scripts
_update_configs
