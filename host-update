#!/usr/bin/env python
# Updates the info of the gentoo servers. Also it merges files under /etc/hosts.d in /etc/hosts

try:
	from BeautifulSoup import BeautifulSoup
except ImportError:
	print "Please emerge -av dev-python/beautifulsoup"
	exit()
from StringIO import StringIO
try:
	import pycurl
except ImportError:
	print "Please emerge -av dev-python/pycurl"
	exit()
import shutil
import socket
import sys
import os
import re

serverlist = []
hostsmodules = ['main', 'home-gr', 'home-cz', 'gentoo-el', 'suse', 'linuxteam', 'kde', 'gentoo']

def fetch_gentoo_serverlist():
	# Fetches the Gentoo servers' names and puts them in the serverlist array
	global serverlist
	b = StringIO()
	conn = pycurl.Curl()
	conn.setopt(pycurl.URL, 'http://www.gentoo.org/proj/en/infrastructure/server-specs.xml?passthru=1')
	conn.setopt(pycurl.WRITEFUNCTION, b.write)
	conn.perform()
	soup = BeautifulSoup(b.getvalue())
	ti = soup.findAll('ti')
	i = 0
	while i < len(ti):
		if ti[i].contents[0][-1] == '*':
			hostname = ti[i].contents[0][:-1]
		else:
			hostname = ti[i].contents[0]
		i = i + 9
		serverlist.append(hostname)

def update_hosts_module(infra):
	# Gets the server's IP, and writes name and IP in /etc/hosts.d/$infra
	global serverlist
	f = open('/etc/hosts.d/%s' % infra, 'w')
	for server in serverlist:
		if infra == 'gentoo':
			domain = 'gentoo.org'
#		elif infra == 'other_infra':
#			domain = 'other_infra.org'
		ip = socket.gethostbyname_ex('%s.%s' % (server, domain))[2][0]
		f.write('%s%s%s\n' % (ip, int(16-len(ip))*' ', server))
	f.close()

def merge_hosts_modules():
	# Merges the files from /etc/hosts.d/* to /etc/hosts
	f = open('/etc/hosts', 'w')
	for hostfile in hostsmodules:
		f.write('\n# %s\n' % hostfile)
		shutil.copyfileobj(open('/etc/hosts.d/%s' % hostfile, 'r'), f)
	f.close()

def hostname_main_hosts_module():
	# Replaces CURRENT_HOST with $HOSTNAME in main module
	prev_file = open("/etc/hosts.d/main").readlines()
	i = 0
	for line in prev_file:
		prev_file[i] = line.replace("CURRENT_HOST", os.uname()[1])
		i = i + 1
	next_file = open("/etc/hosts.d/main", 'w')
	next_file.writelines(prev_file)
	next_file.close()

def main():
	# Check if /etc/hosts.d is a symlink
	if not os.path.islink('/etc/hosts.d'):
		print "/etc/hosts.d is not a symlink or doesn't exist, please run create_symlinks first"
		exit(1)
	# Check if the symlink is valid
	try:
		os.stat('/etc/hosts.d')
	except OSError:
		print "/etc/hosts.d symlink is broken, please fix that first"
		exit(1)
	# Update the content
	try:
		if sys.argv[1]:
			if sys.argv[1] == 'gentoo':
				fetch_gentoo_serverlist()
#			elif sys.argv[1] == 'other_infra':
#				fetch_other_infra_serverlist()
			update_hosts_module(sys.argv[1])
	except IndexError:
		pass
	hostname_main_hosts_module()
	merge_hosts_modules()

if __name__ == '__main__':
	main()
